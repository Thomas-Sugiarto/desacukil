{% extends "base/base.html" %}

{% block title %}{{ content.title }} - Publisher{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Detail Konten</h2>
    <div>
        <a href="{{ url_for('publisher.content_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Kembali
        </a>
        {% if content.status in ['draft', 'rejected'] %}
        <a href="{{ url_for('publisher.edit_content', id=content.id) }}" class="btn btn-primary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        {% endif %}
        <a href="{{ url_for('publisher.preview_content', id=content.id) }}" class="btn btn-info" target="_blank">
            <i class="bi bi-eye"></i> Preview
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <span class="badge bg-{{ content.status|status_badge }} mb-2">
                        {{ content.status|status_text }}
                    </span>
                    {% if content.category %}
                    <span class="badge ms-2" style="background-color: {{ content.category.color }}">
                        {{ content.category.name }}
                    </span>
                    {% endif %}
                </div>
                
                <h1 class="h3 mb-3">{{ content.title }}</h1>
                
                {% if content.cover_image %}
                <div class="mb-3">
                    <img src="{{ get_file_url(content.cover_image) }}" alt="Cover" class="img-fluid rounded">
                </div>
                {% endif %}
                
                {% if content.excerpt %}
                <div class="mb-3">
                    <h5>Ringkasan</h5>
                    <p class="text-muted">{{ content.excerpt }}</p>
                </div>
                {% endif %}
                
                <!-- YouTube Video - Fixed Implementation -->
                {% if content.youtube_url %}
                <div class="mb-4">
                    <h5>Video</h5>
                    <div class="ratio ratio-16x9">
                        <iframe src="{{ get_youtube_embed_url(content.youtube_url) }}" 
                                title="{{ content.title }}" 
                                allowfullscreen>
                        </iframe>
                    </div>
                </div>
                {% endif %}
                
                <div class="content-body">
                    {{ content.content|safe }}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Informasi Konten</h6>
            </div>
            <div class="card-body">
                <p><strong>Status:</strong> 
                    <span class="badge bg-{{ content.status|status_badge }}">
                        {{ content.status|status_text }}
                    </span>
                </p>
                <p><strong>Kategori:</strong> 
                    {% if content.category %}
                        <span class="badge" style="background-color: {{ content.category.color }}">
                            {{ content.category.name }}
                        </span>
                    {% else %}
                        <span class="text-muted">Tidak ada kategori</span>
                    {% endif %}
                </p>
                <p><strong>Penulis:</strong> {{ content.author.full_name }}</p>
                <p><strong>Dibuat:</strong> {{ content.created_at|datetime }}</p>
                <p><strong>Diperbarui:</strong> {{ content.updated_at|datetime }}</p>
                {% if content.published_at %}
                <p><strong>Dipublikasi:</strong> {{ content.published_at|datetime }}</p>
                {% endif %}
                <p><strong>Views:</strong> {{ content.view_count }}</p>
                
                {% if content.review_comment and content.status == 'rejected' %}
                <hr>
                <h6>Komentar Review</h6>
                <div class="alert alert-warning">
                    <small>{{ content.review_comment }}</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if content.status in ['draft', 'rejected'] %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Aksi</h6>
            </div>
            <div class="card-body">
                <button type="button" class="btn btn-success btn-sm w-100 mb-2" onclick="submitForReview({{ content.id }})">
                    <i class="bi bi-send"></i> Kirim untuk Review
                </button>
                {% if content.status == 'draft' %}
                <button type="button" class="btn btn-danger btn-sm w-100" onclick="deleteContent({{ content.id }}, '{{ content.title }}')">
                    <i class="bi bi-trash"></i> Hapus Konten
                </button>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function submitForReview(contentId) {
    if (confirm('Kirim konten untuk review?')) {
        fetch(`{{ url_for('publisher.submit_for_review', id=0) }}`.replace('0', contentId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan');
        });
    }
}

function deleteContent(contentId, title) {
    if (confirm(`Hapus konten "${title}"? Aksi ini tidak dapat dibatalkan.`)) {
        fetch(`{{ url_for('publisher.delete_content', id=0) }}`.replace('0', contentId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{{ url_for("publisher.content_list") }}';
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan');
        });
    }
}
</script>
{% endblock %}